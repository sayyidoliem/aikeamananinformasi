{% extends "base.html" %}

{% block title %}Scan Vulnerability - AI Keamanan Informasi{% endblock %}

{% block content %}
<div class="container py-5">
    <div class="row">
        <div class="col-lg-8 mx-auto">
            <div class="card">
                <div class="card-header bg-danger text-white">
                    <h4 class="mb-0">
                        <i class="bi bi-bug-fill"></i> Scan Vulnerability
                    </h4>
                </div>
                <div class="card-body p-4">
                    <p class="text-muted mb-4">
                        Scan kode, URL, atau konfigurasi untuk mendeteksi potensi kerentanan keamanan.
                    </p>

                    <form id="scanForm">
                        <div class="mb-4">
                            <label for="scanInput" class="form-label fw-bold">Input untuk Scan</label>
                            <textarea 
                                class="form-control font-monospace" 
                                id="scanInput" 
                                rows="8" 
                                placeholder="Masukkan URL, code snippet, atau configuration untuk di-scan..."
                                required
                            ></textarea>
                            <small class="text-muted">
                                Contoh: URL, SQL query, JavaScript code, server configuration, dll.
                            </small>
                        </div>

                        <button type="submit" class="btn btn-danger btn-lg w-100">
                            <i class="bi bi-search"></i> Scan Sekarang
                        </button>
                    </form>

                    <!-- Loading -->
                    <div class="loading text-center my-4" id="loading">
                        <div class="spinner-border text-danger" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p class="mt-2 text-muted">Scanning dengan AI Gemini...</p>
                    </div>

                    <!-- Results -->
                    <div id="results" class="mt-4" style="display: none;">
                        <hr>
                        <h5 class="fw-bold mb-3">
                            <i class="bi bi-clipboard-check"></i> Hasil Scan
                        </h5>
                        
                        <!-- Quick Scan -->
                        <div class="alert alert-warning mb-3">
                            <h6 class="fw-bold">
                                <i class="bi bi-lightning-fill"></i> Quick Scan Results:
                            </h6>
                            <ul id="quickScanList" class="mb-0"></ul>
                        </div>

                        <!-- AI Analysis -->
                        <div class="alert alert-info">
                            <h6 class="fw-bold">
                                <i class="bi bi-robot"></i> AI Analysis:
                            </h6>
                            <div id="scanResult" class="analysis-content"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Common Vulnerabilities Info -->
            <div class="card mt-4">
                <div class="card-header bg-white">
                    <h5 class="mb-0 fw-bold">
                        <i class="bi bi-shield-exclamation"></i> Common Vulnerabilities
                    </h5>
                </div>
                <div class="card-body">
                    <div class="accordion" id="vulnerabilitiesAccordion">
                        <!-- SQL Injection -->
                        <div class="accordion-item">
                            <h2 class="accordion-header">
                                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" 
                                        data-bs-target="#sqlInjection">
                                    <i class="bi bi-database text-danger me-2"></i> SQL Injection
                                </button>
                            </h2>
                            <div id="sqlInjection" class="accordion-collapse collapse" 
                                 data-bs-parent="#vulnerabilitiesAccordion">
                                <div class="accordion-body">
                                    <p><strong>Deskripsi:</strong> Injeksi kode SQL berbahaya ke dalam query database.</p>
                                    <p><strong>Contoh:</strong> <code>SELECT * FROM users WHERE id = '1' OR '1'='1'</code></p>
                                    <p><strong>Pencegahan:</strong> Gunakan prepared statements dan parameterized queries.</p>
                                </div>
                            </div>
                        </div>

                        <!-- XSS -->
                        <div class="accordion-item">
                            <h2 class="accordion-header">
                                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" 
                                        data-bs-target="#xss">
                                    <i class="bi bi-code-slash text-warning me-2"></i> Cross-Site Scripting (XSS)
                                </button>
                            </h2>
                            <div id="xss" class="accordion-collapse collapse" 
                                 data-bs-parent="#vulnerabilitiesAccordion">
                                <div class="accordion-body">
                                    <p><strong>Deskripsi:</strong> Injeksi script berbahaya ke dalam web page.</p>
                                    <p><strong>Contoh:</strong> <code>&lt;script&gt;alert('XSS')&lt;/script&gt;</code></p>
                                    <p><strong>Pencegahan:</strong> Sanitize user input dan encode output.</p>
                                </div>
                            </div>
                        </div>

                        <!-- Path Traversal -->
                        <div class="accordion-item">
                            <h2 class="accordion-header">
                                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" 
                                        data-bs-target="#pathTraversal">
                                    <i class="bi bi-folder2-open text-danger me-2"></i> Path Traversal
                                </button>
                            </h2>
                            <div id="pathTraversal" class="accordion-collapse collapse" 
                                 data-bs-parent="#vulnerabilitiesAccordion">
                                <div class="accordion-body">
                                    <p><strong>Deskripsi:</strong> Akses file di luar direktori yang diizinkan.</p>
                                    <p><strong>Contoh:</strong> <code>../../etc/passwd</code></p>
                                    <p><strong>Pencegahan:</strong> Validate dan sanitize file paths.</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    document.getElementById('scanForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const input = document.getElementById('scanInput').value;
        const loading = document.getElementById('loading');
        const results = document.getElementById('results');
        
        // Show loading
        loading.classList.add('show');
        results.style.display = 'none';
        
        try {
            const response = await fetch('/vulnerability-scan', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ input: input })
            });
            
            const data = await response.json();
            
            // Hide loading
            loading.classList.remove('show');
            
            if (data.success) {
                // Show quick scan results
                const quickScanList = document.getElementById('quickScanList');
                quickScanList.innerHTML = '';
                data.quick_scan.forEach(item => {
                    const li = document.createElement('li');
                    li.textContent = item;
                    quickScanList.appendChild(li);
                });

                // Show AI analysis
                document.getElementById('scanResult').innerHTML = 
                    data.analysis.replace(/\n/g, '<br>');
                
                // Show results
                results.style.display = 'block';
            } else {
                alert('Error: ' + data.error);
            }
        } catch (error) {
            loading.classList.remove('show');
            alert('Terjadi kesalahan: ' + error.message);
        }
    });
</script>
{% endblock %}
